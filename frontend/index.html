<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¦ MiniBank - é“¾ä¸Šå°å‹é“¶è¡Œ</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- å¤´éƒ¨ -->
    <header class="gradient-bg text-white p-6 shadow-lg">
        <div class="container mx-auto">
            <div class="flex items-center justify-between">
                <h1 class="text-3xl font-bold">ğŸ¦ MiniBank</h1>
                <button id="connectBtn" class="bg-white text-purple-600 px-6 py-2 rounded-lg font-semibold hover:bg-gray-100 transition duration-300">
                    è¿æ¥é’±åŒ…
                </button>
            </div>
            <p class="mt-2 text-purple-100">æ‚¨çš„é“¾ä¸Šé“¶è¡Œç³»ç»Ÿ â€¢ å®‰å…¨ â€¢ é€æ˜ â€¢ å»ä¸­å¿ƒåŒ–</p>
        </div>
    </header>

    <!-- ä¸»å†…å®¹ -->
    <main class="container mx-auto p-6">
        <!-- è¿æ¥çŠ¶æ€ -->
        <div id="walletStatus" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 hidden">
            <p class="font-bold">è¯·å…ˆè¿æ¥æ‚¨çš„MetaMaské’±åŒ…</p>
        </div>

        <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
        <div id="userInfo" class="bg-white rounded-xl card-shadow p-6 mb-6 hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ’° æˆ‘çš„è´¦æˆ·</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-blue-600 font-semibold">å½“å‰ä½™é¢</p>
                    <p id="currentBalance" class="text-2xl font-bold text-blue-800">0.000 ETH</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-green-600 font-semibold">å¾…ç»“ç®—åˆ©æ¯</p>
                    <p id="pendingInterest" class="text-2xl font-bold text-green-800">0.000 ETH</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <p class="text-purple-600 font-semibold">ç´¯è®¡å­˜æ¬¾</p>
                    <p id="totalDeposited" class="text-2xl font-bold text-purple-800">0.000 ETH</p>
                </div>
            </div>
        </div>

        <!-- æ“ä½œåŒºåŸŸ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- å­˜æ¬¾å¡ç‰‡ -->
            <div class="bg-white rounded-xl card-shadow p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ’³ å­˜æ¬¾</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å­˜æ¬¾é‡‘é¢ (ETH)</label>
                        <input type="number" id="depositAmount" 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               placeholder="æœ€å°é‡‘é¢: 0.001 ETH" step="0.001" min="0.001">
                    </div>
                    <button id="depositBtn" 
                            class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        å­˜æ¬¾
                    </button>
                </div>
            </div>

            <!-- å–æ¬¾å¡ç‰‡ -->
            <div class="bg-white rounded-xl card-shadow p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ’¸ å–æ¬¾</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å–æ¬¾é‡‘é¢ (ETH)</label>
                        <input type="number" id="withdrawAmount" 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                               placeholder="è¯·è¾“å…¥å–æ¬¾é‡‘é¢" step="0.001" min="0.001">
                    </div>
                    <div class="flex space-x-2">
                        <button id="withdrawBtn" 
                                class="flex-1 bg-red-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-red-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                            å–æ¬¾
                        </button>
                        <button id="withdrawAllBtn" 
                                class="bg-orange-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-orange-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed">
                            å…¨éƒ¨å–å‡º
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- åˆçº¦ç»Ÿè®¡ -->
        <div id="contractStats" class="bg-white rounded-xl card-shadow p-6 mt-6 hidden">
            <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“Š åˆçº¦ç»Ÿè®¡</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center">
                    <p class="text-gray-600">æ€»ç”¨æˆ·æ•°</p>
                    <p id="totalUsers" class="text-2xl font-bold text-blue-600">0</p>
                </div>
                <div class="text-center">
                    <p class="text-gray-600">åˆçº¦æ€»ä½™é¢</p>
                    <p id="contractBalance" class="text-2xl font-bold text-green-600">0.000 ETH</p>
                </div>
                <div class="text-center">
                    <p class="text-gray-600">å¹´åˆ©ç‡</p>
                    <p class="text-2xl font-bold text-purple-600">5%</p>
                </div>
            </div>
        </div>

        <!-- äº¤æ˜“å†å² -->
        <div id="transactionHistory" class="bg-white rounded-xl card-shadow p-6 mt-6 hidden">
            <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ“‹ æœ€è¿‘äº¤æ˜“</h3>
            <div id="transactionList" class="space-y-2">
                <!-- äº¤æ˜“è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </main>

    <!-- çŠ¶æ€æç¤º -->
    <div id="notification" class="fixed top-4 right-4 p-4 rounded-lg shadow-lg hidden transition-all duration-300">
        <p id="notificationText"></p>
    </div>

    <!-- è„šæœ¬ -->
    <script>
        // åˆçº¦é…ç½®ï¼ˆè¯·æ›¿æ¢ä¸ºå®é™…éƒ¨ç½²çš„åˆçº¦åœ°å€ï¼‰
        const CONTRACT_ADDRESS = "0x5FbDB2315678afecb367f032d93F642f64180aa3"; // æœ¬åœ°éƒ¨ç½²åœ°å€
        const CONTRACT_ABI = [
            // è¿™é‡Œéœ€è¦ä» artifacts/contracts/MiniBank.sol/MiniBank.json å¤åˆ¶ABI
            // ä¸ºäº†æ¼”ç¤ºï¼Œè¿™é‡Œåªåˆ—å‡ºä¸»è¦å‡½æ•°
            "function deposit() external payable",
            "function withdraw(uint256 amount) external",
            "function withdrawAll() external",
            "function getMyBalance() external view returns (uint256)",
            "function getMyDepositInfo() external view returns (uint256,uint256,uint256,uint256,uint256)",
            "function getContractStats() external view returns (uint256,uint256,uint256)",
            "function calculateInterest(address) external view returns (uint256)",
            "event Deposited(address indexed user, uint256 amount, uint256 newBalance)",
            "event Withdrawn(address indexed user, uint256 amount, uint256 newBalance)",
            "event InterestAccrued(address indexed user, uint256 interestAmount)"
        ];

        let provider, signer, contract, userAddress;

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined') {
                console.log('MetaMaskå·²å®‰è£…');
                await checkConnection();
            } else {
                showNotification('è¯·å®‰è£…MetaMaské’±åŒ…', 'error');
            }

            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            document.getElementById('connectBtn').addEventListener('click', connectWallet);
            document.getElementById('depositBtn').addEventListener('click', deposit);
            document.getElementById('withdrawBtn').addEventListener('click', withdraw);
            document.getElementById('withdrawAllBtn').addEventListener('click', withdrawAll);
        });

        // æ£€æŸ¥è¿æ¥çŠ¶æ€
        async function checkConnection() {
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            if (accounts.length > 0) {
                await setupWeb3();
            } else {
                showWalletStatus();
            }
        }

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                await setupWeb3();
                showNotification('é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
                showNotification('è¿æ¥é’±åŒ…å¤±è´¥', 'error');
            }
        }

        // è®¾ç½®Web3
        async function setupWeb3() {
            provider = new ethers.providers.Web3Provider(window.ethereum);
            signer = provider.getSigner();
            userAddress = await signer.getAddress();
            contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

            // æ›´æ–°UI
            document.getElementById('connectBtn').textContent = `${userAddress.substring(0,6)}...${userAddress.substring(38)}`;
            document.getElementById('walletStatus').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('contractStats').classList.remove('hidden');
            document.getElementById('transactionHistory').classList.remove('hidden');

            // åŠ è½½æ•°æ®
            await loadUserData();
            await loadContractStats();
            
            // ç›‘å¬äº‹ä»¶
            setupEventListeners();
        }

        // æ˜¾ç¤ºé’±åŒ…çŠ¶æ€
        function showWalletStatus() {
            document.getElementById('walletStatus').classList.remove('hidden');
        }

        // åŠ è½½ç”¨æˆ·æ•°æ®
        async function loadUserData() {
            try {
                const [balance, pendingInterest, totalDeposited, totalWithdrawn, lastTime] = 
                    await contract.getMyDepositInfo();

                document.getElementById('currentBalance').textContent = 
                    `${ethers.utils.formatEther(balance)} ETH`;
                document.getElementById('pendingInterest').textContent = 
                    `${ethers.utils.formatEther(pendingInterest)} ETH`;
                document.getElementById('totalDeposited').textContent = 
                    `${ethers.utils.formatEther(totalDeposited)} ETH`;
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
            }
        }

        // åŠ è½½åˆçº¦ç»Ÿè®¡
        async function loadContractStats() {
            try {
                const [contractBalance, totalUsers, totalSupply] = await contract.getContractStats();
                
                document.getElementById('totalUsers').textContent = totalUsers.toString();
                document.getElementById('contractBalance').textContent = 
                    `${ethers.utils.formatEther(contractBalance)} ETH`;
            } catch (error) {
                console.error('åŠ è½½åˆçº¦ç»Ÿè®¡å¤±è´¥:', error);
            }
        }

        // å­˜æ¬¾
        async function deposit() {
            const amount = document.getElementById('depositAmount').value;
            if (!amount || parseFloat(amount) < 0.001) {
                showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„å­˜æ¬¾é‡‘é¢ï¼ˆæœ€å°0.001 ETHï¼‰', 'error');
                return;
            }

            try {
                const tx = await contract.deposit({ 
                    value: ethers.utils.parseEther(amount) 
                });
                
                showNotification('äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...', 'info');
                await tx.wait();
                
                showNotification('å­˜æ¬¾æˆåŠŸï¼', 'success');
                document.getElementById('depositAmount').value = '';
                await loadUserData();
                await loadContractStats();
            } catch (error) {
                console.error('å­˜æ¬¾å¤±è´¥:', error);
                showNotification('å­˜æ¬¾å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å–æ¬¾
        async function withdraw() {
            const amount = document.getElementById('withdrawAmount').value;
            if (!amount || parseFloat(amount) <= 0) {
                showNotification('è¯·è¾“å…¥æœ‰æ•ˆçš„å–æ¬¾é‡‘é¢', 'error');
                return;
            }

            try {
                const tx = await contract.withdraw(ethers.utils.parseEther(amount));
                
                showNotification('äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...', 'info');
                await tx.wait();
                
                showNotification('å–æ¬¾æˆåŠŸï¼', 'success');
                document.getElementById('withdrawAmount').value = '';
                await loadUserData();
                await loadContractStats();
            } catch (error) {
                console.error('å–æ¬¾å¤±è´¥:', error);
                showNotification('å–æ¬¾å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å…¨éƒ¨å–å‡º
        async function withdrawAll() {
            if (!confirm('ç¡®å®šè¦å–å‡ºæ‰€æœ‰ä½™é¢å—ï¼Ÿ')) return;

            try {
                const tx = await contract.withdrawAll();
                
                showNotification('äº¤æ˜“å·²æäº¤ï¼Œç­‰å¾…ç¡®è®¤...', 'info');
                await tx.wait();
                
                showNotification('å…¨éƒ¨å–å‡ºæˆåŠŸï¼', 'success');
                await loadUserData();
                await loadContractStats();
            } catch (error) {
                console.error('å…¨éƒ¨å–å‡ºå¤±è´¥:', error);
                showNotification('å…¨éƒ¨å–å‡ºå¤±è´¥: ' + error.message, 'error');
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬
        function setupEventListeners() {
            contract.on("Deposited", (user, amount, newBalance) => {
                if (user.toLowerCase() === userAddress.toLowerCase()) {
                    addTransaction('å­˜æ¬¾', ethers.utils.formatEther(amount), 'success');
                    loadUserData();
                }
            });

            contract.on("Withdrawn", (user, amount, newBalance) => {
                if (user.toLowerCase() === userAddress.toLowerCase()) {
                    addTransaction('å–æ¬¾', ethers.utils.formatEther(amount), 'warning');
                    loadUserData();
                }
            });

            contract.on("InterestAccrued", (user, interestAmount) => {
                if (user.toLowerCase() === userAddress.toLowerCase()) {
                    addTransaction('åˆ©æ¯', ethers.utils.formatEther(interestAmount), 'info');
                }
            });
        }

        // æ·»åŠ äº¤æ˜“è®°å½•
        function addTransaction(type, amount, style) {
            const transactionList = document.getElementById('transactionList');
            const now = new Date().toLocaleString();
            
            const styleClasses = {
                'success': 'text-green-600 bg-green-50',
                'warning': 'text-orange-600 bg-orange-50',
                'info': 'text-blue-600 bg-blue-50'
            };

            const transactionElement = document.createElement('div');
            transactionElement.className = `p-3 rounded-lg ${styleClasses[style]}`;
            transactionElement.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="font-semibold">${type}: ${amount} ETH</span>
                    <span class="text-sm">${now}</span>
                </div>
            `;
            
            transactionList.insertBefore(transactionElement, transactionList.firstChild);
            
            // åªä¿ç•™æœ€è¿‘10æ¡è®°å½•
            while (transactionList.children.length > 10) {
                transactionList.removeChild(transactionList.lastChild);
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            const typeClasses = {
                'success': 'bg-green-500 text-white',
                'error': 'bg-red-500 text-white',
                'info': 'bg-blue-500 text-white',
                'warning': 'bg-yellow-500 text-black'
            };

            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg ${typeClasses[type]} transition-all duration-300`;
            notificationText.textContent = message;
            notification.classList.remove('hidden');

            setTimeout(() => {
                notification.classList.add('hidden');
            }, 5000);
        }

        // å®šæœŸæ›´æ–°æ•°æ®
        setInterval(async () => {
            if (contract && userAddress) {
                await loadUserData();
                await loadContractStats();
            }
        }, 30000); // æ¯30ç§’æ›´æ–°ä¸€æ¬¡
    </script>
</body>
</html> 